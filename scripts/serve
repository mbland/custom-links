#! /usr/local/env bash
#
# Runs a local url-pointers server or a live-server for UI tests
#
# Usage:
#   {{go}} {{cmd}} [--test|<config-file>]
#
# Where:
#   --test         Run live-server for unauthenticated local UI testing
#   <config-file>  url-pointers configuration file
#
# When running a url-pointers server, there must be a redis-server already
# running.

readonly COVERAGE_MIDDLEWARE="$_GO_ROOTDIR/tests/helpers/coverage-middleware.js"

urlp.serve_tab_completion() {
  local word_index="$1"
  shift
  local args=("$@")
  local word="${args[$word_index]}"

  if [[ "$word_index" -eq '0' ]]; then
    printf -- '--test --coverage\n'
    if [[ "${1:0:1}" == '-' ]]; then
      return
    fi
    @go.compgen -f -- "$word"
  fi
}

urlp.serve() {
  local server_config="${1:-$_GO_ROOTDIR/test-config.json}"
  local test_server
  local test_args=('--open=/tests/')

  case "$1" in
  --complete)
    # Tab completions
    shift
    urlp.serve_tab_completion "$@"
    return
    ;;
  --test)
    test_server='true'
    ;;
  --coverage)
    test_server='true'
    test_args+=("--middleware=$COVERAGE_MIDDLEWARE")
    ;;
  esac

  if [[ "$test_server" == 'true' ]]; then
    live-server "${test_args[@]}" public/
  else
    node "$_GO_ROOTDIR/index.js" "$server_config"
  fi
}

urlp.serve "$@"
