#! /bin/bash
# 
# Run all automated tests
#
# Usage:
#   {{go}} {{cmd}} [--coverage]
#
# Options:
#   --coverage    Collect test coverage data using nyc/istanbul
#
# The '--coverage' flag will place its output in a directory called 'coverage'.
# An HTML report will be available at 'coverage/lcov-report/index.html'.

_test_tab_completion() {
  local word_index="$1"
  shift
  local args=("$@")
  local word="${args[$word_index]}"

  if [[ "$word_index" -eq '0' ]]; then
    @go.compgen -W '--coverage' -- "$1"
  fi
}

_test() {
  local coverage_run
  local flags=()
  local result='0'

  case "$1" in
  --complete)
    # Tab completions
    shift
    _test_tab_completion "$@"
    return
    ;;
  --coverage)
    coverage_run='true'
    flags=('--coverage')
    . "$_GO_USE_MODULES" 'coverage'
    ;;
  esac

  export __TEST_ALL='true'

  if ! @go test server "${flags[@]}" || ! @go test browser "${flags[@]}" ||
    ! @go test end-to-end; then
    result='1'
  fi

  if [[ -n "$coverage_run" ]] && ! urlp.generate_coverage_report; then
    result='1'
  fi
  return "$result"
}

_test "$@"
