#! /usr/bin/env bash
#
# Runs first-time setup commands for a freshly-cloned repository

urlp.check_for_prerequisite_tools() {
  if ! command -v node >/dev/null; then
    printf 'Please install Node.js before continuing.\n' >&2
    return 1
  fi
}

urlp.install_required_tools() {
  if ! command -v phantomjs >/dev/null; then
    npm install phantomjs-prebuilt
  fi
}

urlp.setup() {
  local result='0'

  export PATH="node_modules/.bin:$PATH"
  export FORCE_COLOR='true'

  @go.critical_section_begin
  @go.log START 'Setting up project...'
  urlp.check_for_prerequisite_tools

  if [[ ! -d "$_GO_ROOTDIR/node_modules" ]]; then
    @go.log_command npm install
  fi
  urlp.install_required_tools
  @go.critical_section_end

  if ! @go.log_command @go lint; then
    result='1'
  fi
  if ! @go.log_command @go test --coverage; then
    result='1'
  fi

  if [[ "$result" -eq '0' ]]; then
    @go.log FINISH 'Project setup completed successfully.'
  fi
}

urlp.setup "$@"
